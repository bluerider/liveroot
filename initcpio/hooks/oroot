#!/bin/ash

run_hook() {
  if [ "${oroot}" ]; then
     root=$(resolve_device $(echo $root | grep UUID))
     $mount_handler /lroot
     modprobe zram num_devices=$(nproc)
     if [ "${quiet}" ]; then
        zramctl find $(free -m | awk '/Mem/ {print int($2/2)}')M lzo $(nproc) &>/dev/null
      else
        zramctl find $(free -m | awk '/Mem/ {print int($2/2)}')M lzo $(nproc)
     fi;
     if [ "${oroot}" = "compressed" ]; then
        if [ "${quiet}" ]; then
           zramctl find $(free -m | awk '/Mem/ {print int($2/2)}')M lzo $(nproc) &>/dev/null
           mkfs.ext2 /dev/zram1 &>/dev/null
         else
           zramctl find $(free -m | awk '/Mem/ {print int($2/2)}')M lzo $(nproc)
           mkfs.ext2 /dev/zram1
        fi;
        mount /dev/zram1 /troot
      elif [ "${oroot}" = "raw" ]; then
        mount troot -t tmpfs /troot
     fi;
     mkdir /troot/upper
     mkdir /troot/work
     if [ "${quiet}" ]; then
        mkswap /dev/zram0 &>/dev/null
        swapon /dev/zram0 &>/devnull
      else
        mkswap /dev/zram0
        swapon /dev/zram0
     fi;
     oroot_mount() {
       mount oroot -t overlay -o lowerdir=/lroot,upperdir=/troot/upper,workdir=/troot/work "$1"
     }
     mount_handler=oroot_mount
  fi;
}